on:
  push:
    branches:
      - main
  pull_request: {}

name: Build and Deploy

jobs:
  build_and_deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Cache Idris2
        uses: actions/cache@v3
        id: cache-idris2
        with:
          path: |
            ~/.idris2
            /usr/local/bin/idris2
            /usr/local/bin/idris2_app
          key: idris2-0.8.0-${{ runner.os }}

      - name: Install dependencies
        if: steps.cache-idris2.outputs.cache-hit != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y chezscheme libgmp-dev

      - name: Install Idris2
        if: steps.cache-idris2.outputs.cache-hit != 'true'
        run: |
          git clone https://github.com/idris-lang/Idris2.git
          cd Idris2
          git checkout v0.8.0
          make bootstrap SCHEME=scheme
          sudo make install PREFIX=/usr/local
          sudo make install-api PREFIX=/usr/local
          cd ..
          rm -rf Idris2

      - name: Verify Idris2
        run: |
          export PATH="/usr/local/bin:$HOME/.idris2/bin:$PATH"
          idris2 --version
          # Check for support files
          find ~/.idris2 /usr/local -name "support.js" 2>/dev/null || echo "Warning: support.js not found"

      - name: Build project
        run: |
          export PATH="/usr/local/bin:$HOME/.idris2/bin:$PATH"
          idris2 --codegen javascript --build respo.ipkg

      - name: Prepare distribution
        run: |
          mkdir -p dist
          cp index.html dist/
          cp build/exec/respo dist/respo.js
          # Create a minimal package for deployment
          ls -la dist/

      - name: Deploy to server
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        id: deploy
        uses: Pendect/action-rsyncer@v2.0.0
        env:
          DEPLOY_KEY: ${{secrets.rsync_private_key}}
        with:
          flags: "-avzr --progress"
          options: ""
          ssh_options: ""
          src: "dist/*"
          dest: "rsync-user@tiye.me:/web-assets/repo/${{ github.repository }}"

      - name: Display status from deploy
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: echo "${{ steps.deploy.outputs.status }}"
